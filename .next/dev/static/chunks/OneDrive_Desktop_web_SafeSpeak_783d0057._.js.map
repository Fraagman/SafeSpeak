{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/saksham/OneDrive/Desktop/web/SafeSpeak/src/app/chat/page.tsx"],"sourcesContent":["\"use client\";\n\nimport React, { useEffect, useMemo, useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport {\n  getAuth,\n  onAuthStateChanged,\n  signInAnonymously,\n  User,\n} from \"firebase/auth\";\nimport {\n  getFirestore,\n  collection,\n  query,\n  where,\n  getDocs,\n  addDoc,\n  serverTimestamp,\n  Firestore,\n  doc,\n  updateDoc,\n  arrayRemove,\n} from \"firebase/firestore\";\n\n// Ensure an anonymous user is signed in and return the current user.\nasync function ensureAnon(): Promise<User> {\n  const auth = getAuth();\n  // If already signed in, return immediately\n  if (auth.currentUser) return auth.currentUser;\n\n  // Wait for initial auth state; if still no user, sign in anonymously\n  const user = await new Promise<User>(async (resolve, reject) => {\n    const unsubscribe = onAuthStateChanged(\n      auth,\n      (u) => {\n        if (u) {\n          unsubscribe();\n          resolve(u);\n        }\n      },\n      (err) => {\n        unsubscribe();\n        reject(err);\n      }\n    );\n\n    try {\n      await signInAnonymously(auth);\n    } catch (e) {\n      // If sign-in fails but an auth state comes in, it will resolve via onAuthStateChanged\n      // Otherwise, reject here\n      // eslint-disable-next-line no-console\n      console.error(\"Anonymous sign-in failed:\", e);\n    }\n  });\n\n  return user;\n}\n\nasync function fetchUserChats(db: Firestore, uid: string): Promise<string[]> {\n  const q = query(\n    collection(db, \"chats\"),\n    where(\"participants\", \"array-contains\", uid)\n  );\n  const snap = await getDocs(q);\n  return snap.docs.map((d) => d.id);\n}\n\nasync function createNewChat(db: Firestore, uid: string): Promise<string> {\n  const docRef = await addDoc(collection(db, \"chats\"), {\n    participants: [uid],\n    createdAt: serverTimestamp(),\n    updatedAt: serverTimestamp(),\n  });\n  return docRef.id;\n}\n\nexport default function ChatIndexPage() {\n  const router = useRouter();\n  const [loading, setLoading] = useState(true);\n  const [chatIds, setChatIds] = useState<string[] | null>(null);\n  const [error, setError] = useState<string | null>(null);\n\n  const db = useMemo(() => getFirestore(), []);\n\n  useEffect(() => {\n    let cancelled = false;\n\n    async function init() {\n      try {\n        setLoading(true);\n        const user = await ensureAnon();\n        if (!user?.uid) throw new Error(\"No user available after ensureAnon()\");\n\n        const ids = await fetchUserChats(db, user.uid);\n        if (cancelled) return;\n\n        if (!ids.length) {\n          // No active chats, create one and redirect\n          const newId = await createNewChat(db, user.uid);\n          if (cancelled) return;\n          router.replace(`/chat/${newId}`);\n          return;\n        }\n\n        // Have chats: show list\n        setChatIds(ids);\n      } catch (e: any) {\n        // eslint-disable-next-line no-console\n        console.error(e);\n        setError(e?.message || \"Failed to load chats\");\n      } finally {\n        if (!cancelled) setLoading(false);\n      }\n    }\n\n    void init();\n    return () => {\n      cancelled = true;\n    };\n  }, [db, router]);\n\n  async function handleStartNewChat() {\n    try {\n      setLoading(true);\n      const auth = getAuth();\n      const user = auth.currentUser || (await ensureAnon());\n      if (!user?.uid) throw new Error(\"No user available\");\n      const newId = await createNewChat(db, user.uid);\n      router.replace(`/chat/${newId}`);\n    } catch (e: any) {\n      setError(e?.message || \"Failed to start a new chat\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function handleLeaveChat(chatId: string) {\n    try {\n      const auth = getAuth();\n      const user = auth.currentUser || (await ensureAnon());\n      if (!user?.uid) throw new Error(\"No user available\");\n      const chatRef = doc(db, \"chats\", chatId);\n      await updateDoc(chatRef, { participants: arrayRemove(user.uid) });\n      // Optimistically remove from local state immediately\n      setChatIds((prev) => (Array.isArray(prev) ? prev.filter((id) => id !== chatId) : prev));\n    } catch (e) {\n      // eslint-disable-next-line no-console\n      console.error(e);\n      alert(\"Failed to remove chat. Please try again.\");\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center h-[60vh] text-gray-600\">\n        Loading chats...\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"max-w-xl mx-auto p-4\">\n        <div className=\"mb-4 text-red-600 font-medium\">{error}</div>\n        <button\n          className=\"px-4 py-2 rounded bg-blue-600 text-white\"\n          onClick={() => location.reload()}\n        >\n          Retry\n        </button>\n      </div>\n    );\n  }\n\n  // If we have chatIds, render a simple list with actions\n  return (\n    <div className=\"max-w-2xl mx-auto p-4\">\n      <div className=\"flex items-center justify-between mb-4\">\n        <h1 className=\"text-xl font-semibold\">Your Chats</h1>\n        <div className=\"flex items-center gap-2\">\n          <button\n            className=\"px-3 py-2 rounded bg-green-600 text-white\"\n            onClick={handleStartNewChat}\n            title=\"Create a private, personal chat\"\n          >\n            Start New Chat\n          </button>\n          <button\n            className=\"px-3 py-2 rounded bg-indigo-600 text-white\"\n            onClick={() => router.push('/community')}\n            title=\"Join the anonymous community forum\"\n          >\n            Join Anonymous Community\n          </button>\n        </div>\n      </div>\n\n      {Array.isArray(chatIds) && chatIds.length > 0 ? (\n        <ul className=\"space-y-2\">\n          {chatIds.map((id) => (\n            <li key={id} className=\"flex items-center justify-between p-3 border rounded gap-2\">\n              <div className=\"truncate\">Chat {id}</div>\n              <div className=\"flex items-center gap-2\">\n                <button\n                  className=\"px-3 py-1.5 rounded bg-blue-600 text-white\"\n                  onClick={() => router.replace(`/chat/${id}`)}\n                >\n                  Open\n                </button>\n                <button\n                  className=\"px-3 py-1.5 rounded bg-red-600 text-white\"\n                  onClick={async () => {\n                    const ok = window.confirm(\n                      \"Are you sure you want to remove this chat from your list? You can only join it again if you know the ID.\"\n                    );\n                    if (ok) await handleLeaveChat(id);\n                  }}\n                >\n                  Remove\n                </button>\n              </div>\n            </li>\n          ))}\n        </ul>\n      ) : (\n        <div className=\"text-gray-600\">No chats found.</div>\n      )}\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 315, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/saksham/OneDrive/Desktop/web/SafeSpeak/node_modules/next/navigation.js"],"sourcesContent":["module.exports = require('./dist/client/components/navigation')\n"],"names":[],"mappings":"AAAA,OAAO,OAAO","ignoreList":[0],"debugId":null}}]
}