{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/saksham/OneDrive/Desktop/web/SafeSpeak/src/lib/chatCrypto.ts"],"sourcesContent":["import nacl from \"tweetnacl\";\r\nimport naclUtil from \"tweetnacl-util\";\r\nexport function genKeypair() { const kp = nacl.box.keyPair();\r\n  return { publicKey: naclUtil.encodeBase64(kp.publicKey), secretKey: naclUtil.encodeBase64(kp.secretKey) }; }\r\nexport function deriveSharedKey(peerPubB64: string, mySecretB64: string) {\r\n  const peer = naclUtil.decodeBase64(peerPubB64); const my = naclUtil.decodeBase64(mySecretB64);\r\n  return nacl.box.before(peer, my);\r\n}\r\nexport function encryptMessage(sharedKey: Uint8Array, msg: string) {\r\n  const nonce = nacl.randomBytes(24); const box = nacl.secretbox(naclUtil.decodeUTF8(msg), nonce, sharedKey);\r\n  return { ciphertext: naclUtil.encodeBase64(box), nonce: naclUtil.encodeBase64(nonce) };\r\n}\r\nexport function decryptMessage(sharedKey: Uint8Array, ciphertextB64: string, nonceB64: string) {\r\n  const msg = nacl.secretbox.open(naclUtil.decodeBase64(ciphertextB64), naclUtil.decodeBase64(nonceB64), sharedKey);\r\n  return msg ? naclUtil.encodeUTF8(msg) : null;\r\n}"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;;;AACO,SAAS;IAAe,MAAM,KAAK,+LAAI,CAAC,GAAG,CAAC,OAAO;IACxD,OAAO;QAAE,WAAW,uMAAQ,CAAC,YAAY,CAAC,GAAG,SAAS;QAAG,WAAW,uMAAQ,CAAC,YAAY,CAAC,GAAG,SAAS;IAAE;AAAG;AACtG,SAAS,gBAAgB,UAAkB,EAAE,WAAmB;IACrE,MAAM,OAAO,uMAAQ,CAAC,YAAY,CAAC;IAAa,MAAM,KAAK,uMAAQ,CAAC,YAAY,CAAC;IACjF,OAAO,+LAAI,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM;AAC/B;AACO,SAAS,eAAe,SAAqB,EAAE,GAAW;IAC/D,MAAM,QAAQ,+LAAI,CAAC,WAAW,CAAC;IAAK,MAAM,MAAM,+LAAI,CAAC,SAAS,CAAC,uMAAQ,CAAC,UAAU,CAAC,MAAM,OAAO;IAChG,OAAO;QAAE,YAAY,uMAAQ,CAAC,YAAY,CAAC;QAAM,OAAO,uMAAQ,CAAC,YAAY,CAAC;IAAO;AACvF;AACO,SAAS,eAAe,SAAqB,EAAE,aAAqB,EAAE,QAAgB;IAC3F,MAAM,MAAM,+LAAI,CAAC,SAAS,CAAC,IAAI,CAAC,uMAAQ,CAAC,YAAY,CAAC,gBAAgB,uMAAQ,CAAC,YAAY,CAAC,WAAW;IACvG,OAAO,MAAM,uMAAQ,CAAC,UAAU,CAAC,OAAO;AAC1C","debugId":null}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/saksham/OneDrive/Desktop/web/SafeSpeak/src/app/chat/%5BchatId%5D/page.tsx"],"sourcesContent":["\"use client\";\nimport { useEffect, useState } from \"react\";\nimport { useParams, useRouter } from \"next/navigation\";\nimport { ensureAnon, auth, db } from \"@/lib/firebase\";\nimport { doc, getDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, where, getDocs, deleteDoc, updateDoc, arrayRemove } from \"firebase/firestore\";\nimport { genKeypair, deriveSharedKey, encryptMessage, decryptMessage } from \"@/lib/chatCrypto\";\n\nexport default function ChatPage() {\n  const { chatId } = useParams() as { chatId: string };\n  const router = useRouter();\n  const [sharedKey, setSharedKey] = useState<Uint8Array | null>(null);\n  const [messages, setMessages] = useState<any[]>([]);\n  const [text, setText] = useState(\"\");\n\n  useEffect(() => { ensureAnon(); }, []);\n  useEffect(() => { (async () => {\n    const chatRef = doc(db, \"chats\", chatId); const chatSnap = await getDoc(chatRef);\n    if (!chatSnap.exists()) return; const data = chatSnap.data() as any;\n    let mySecret = localStorage.getItem(`chat:${chatId}:sk`);\n    if (!mySecret) { const kp = genKeypair();\n      localStorage.setItem(`chat:${chatId}:sk`, kp.secretKey);\n      localStorage.setItem(`chat:${chatId}:pk`, kp.publicKey);\n      mySecret = kp.secretKey; }\n    const peerPub = data.ngoPublicKey || data.initiatorPublicKey; if (!peerPub) return;\n    setSharedKey(deriveSharedKey(peerPub, mySecret));\n    const msgsRef = collection(chatRef, \"messages\"); const q = query(msgsRef, orderBy(\"createdAt\",\"asc\"));\n    const unsub = onSnapshot(q, snap => {\n      const now = Date.now(); const arr: any[] = [];\n      snap.forEach(d => { const m = { id: d.id, ...d.data() } as any;\n        if (!m.expiresAt || m.expiresAt > now) arr.push(m); });\n      setMessages(arr);\n    });\n    return () => unsub();\n  })(); }, [chatId]);\n\n  async function send() {\n    if (!sharedKey || !text.trim()) return;\n    const user = auth.currentUser!; const { ciphertext, nonce } = encryptMessage(sharedKey, text.trim());\n    const chatRef = doc(db, \"chats\", chatId);\n    await addDoc(collection(chatRef, \"messages\"), { senderUid: user.uid, ciphertext, nonce, createdAt: serverTimestamp(), expiresAt: Date.now() + 24*60*60*1000 });\n    setText(\"\");\n  }\n  async function purgeExpired() {\n    const chatRef = doc(db, \"chats\", chatId); const msgsRef = collection(chatRef, \"messages\");\n    const snap = await getDocs(query(msgsRef, where(\"expiresAt\",\"<=\", Date.now())));\n    await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));\n  }\n\n  async function handleLeaveChat() {\n    await ensureAnon();\n    const uid = auth.currentUser?.uid;\n    if (!uid) return;\n    const chatRef = doc(db, \"chats\", chatId);\n    await updateDoc(chatRef, { participants: arrayRemove(uid) });\n    router.push(\"/chat\");\n  }\n\n  return (\n    <main className=\"max-w-xl mx-auto p-4 space-y-3\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-xl font-semibold\">Secure Chat</h2>\n        <button\n          className=\"text-sm px-3 py-1.5 rounded bg-red-600 text-white\"\n          onClick={() => {\n            const ok = window.confirm(\n              \"Are you sure you want to delete this chat? This will only remove it from your list, but counselors may still see the record.\"\n            );\n            if (ok) {\n              void handleLeaveChat();\n            }\n          }}\n        >\n          Delete Chat\n        </button>\n      </div>\n      <div className=\"border rounded p-3 h-96 overflow-auto bg-white\">\n        {messages.map(m => {\n          const body = sharedKey ? decryptMessage(sharedKey, m.ciphertext, m.nonce) : \"...\";\n          const mine = m.senderUid === auth.currentUser?.uid;\n          return (\n            <div key={m.id} className={`my-2 ${mine ? \"text-right\" : \"text-left\"}`}>\n              <span className={`inline-block px-3 py-2 rounded ${mine ? \"bg-emerald-100\" : \"bg-slate-100\"}`}>{body}</span>\n            </div>\n          );\n        })}\n      </div>\n      <div className=\"flex gap-2\">\n        <input className=\"flex-1 border p-2\" value={text} onChange={e=>setText(e.target.value)} placeholder=\"Type a message...\" aria-label=\"Message input\" />\n        <button onClick={send} className=\"bg-emerald-600 text-white px-4 py-2 rounded\" aria-label=\"Send message\">Send</button>\n        <button onClick={purgeExpired} className=\"bg-slate-200 px-3 rounded\" title=\"Delete expired messages\">Purge</button>\n      </div>\n    </main>\n  );\n}"],"names":[],"mappings":"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","debugId":null}}]
}